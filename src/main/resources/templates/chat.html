<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Chat App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.1/stomp.min.js"></script>
</head>
<body>
<div class="container mt-4">
  <h1>Real-Time Chat Application</h1>
  <div id="status" class="alert alert-info">Connecting...</div>
  <div id="chat" class="border rounded p-3 mb-3" style="height:300px; overflow-y:auto;"></div>
  <div class="input-group mb-3">
    <input id="senderInput" type="text" class="form-control" placeholder="Your name..." required/>
  </div>
  <div class="input-group mb-3">
    <input id="messageInput" type="text" class="form-control" placeholder="Type a message..." required/>
    <div class="input-group-append">
      <button id="sendMessage" class="btn btn-primary" disabled>Send</button>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  const statusDiv = document.getElementById('status');

  function connect() {
      const socket = new SockJS('/chat');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function(frame) {
          setConnected(true);
          statusDiv.className = 'alert alert-success';
          statusDiv.textContent = 'Connected!';

          stompClient.subscribe('/topic/messages', function(message) {
              showMessage(JSON.parse(message.body));
          });
      }, function(error) {
          console.error("WebSocket Connection Error:", error);
          statusDiv.className = 'alert alert-danger';
          statusDiv.textContent = 'Connection lost. Attempting to reconnect...';
          setTimeout(connect, 5000);
      });
  }

  function setConnected(connected) {
      document.getElementById('sendMessage').disabled = !connected;
  }

  function showMessage(message) {
      const chat = document.getElementById('chat');
      const messageElement = document.createElement('div');
      messageElement.innerHTML = `
          <strong>${escapeHtml(message.sender)}</strong>: ${escapeHtml(message.content)}
      `;
      messageElement.classList.add("border-bottom", "mb-1", "p-2");
      chat.appendChild(messageElement);
      chat.scrollTop = chat.scrollHeight;
  }

  function escapeHtml(unsafe) {
      return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
  }

  function sendMessage(event) {
      event.preventDefault();

      const sender = document.getElementById('senderInput').value.trim();
      const content = document.getElementById('messageInput').value.trim();

      if (!sender || !content) {
          return;
      }

      const chatMessage = {
          sender: sender,
          content: content
      };

      try {
          stompClient.send("/app/sendMessage", {}, JSON.stringify(chatMessage));
          document.getElementById('messageInput').value = '';
      } catch (error) {
          console.error("Error sending message:", error);
          statusDiv.className = 'alert alert-danger';
          statusDiv.textContent = 'Failed to send message. Please try again.';
      }
  }

  document.getElementById('sendMessage').addEventListener("click", sendMessage);
  document.getElementById('messageInput').addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
          sendMessage(event);
      }
  });

  window.onload = connect;
  window.onbeforeunload = function() {
      if (stompClient !== null) {
          stompClient.disconnect();
      }
  };
</script>
</body>
</html>